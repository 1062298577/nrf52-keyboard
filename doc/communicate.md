# 通讯协议文档

## UART 通讯协议

### 基础格式

CMD DAT ... DAT SUM

- CMD：命令
- DAT：数据
- SUM：前面所有数据和命令的校验和

其中，根据CMD的不同，DAT的长度可能有所变化。若DAT长度为0，则不需要SUM。

主机(CH554)会定期向从机(nRF52810)发送状态数据包，请求从机上传。

### 命令

#### Ping 包与当前状态
```
0b0001 xxxx
       ||||
       |||+--- 上次接收数据是否成功（成功置为1）
       ||+---- 充电状态（充满置为1）
       |+----- 主机状态（与主机连接成功置为1）
       +------ 当前键盘的Protocol
```

无DAT

#### LED 下传
```
0b001x xxxx
     + ++++--- 5Bit的LED状态
```

无DAT

#### HID 通信
```
0b01xx xxxx
    ++ ++++--- HID 数据包的长度-1，最大为63，即HID最大长度为64
```
DAT第一位是HID REPORT ID
0: keyboard, 1: mouse, 2: consumer, 3: system, 0x80: nkro keyboard

#### 配置通信
```
0b10xx xxxx 
    || ||||
    ++-++++--- HID 数据包的长度-1，最大为63，即HID最大长度为64
```
DAT 的长度由上面决定。

#### Keymap 响应
同 Ping 包与当前状态的格式。0x10为校验和失败，0x11为单包发送成功，0x12为所有包发送完毕
